<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Admin Panel - Leads</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .08);
    }

    th,
    td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: left;
      font-size: 14px;
    }

    th {
      background: #2563eb;
      color: white;
      position: sticky;
      top: 0;
    }

    tr:hover {
      background: #f1f5f9;
    }

    tr.has-remark {
      background: #fef9c3;
    }

    button {
      background: #2563eb;
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }

    button:hover {
      background: #1d4ed8;
    }

    .nowrap {
      white-space: nowrap;
    }

    .mono {
      font-family: monospace;
    }

    .filters{
      margin-bottom: 10px;
      display: flex;
      justify-content: space-evenly;
    }
    .filters input {
      width: 13%;
      padding: 4px;
      font-size: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    /* Modal */
    #remarkModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    #remarkModal .modal-box {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      width: 600px;
      max-width: 95%;
      max-height: 90%;
      display: flex;
      flex-direction: column;
    }

    #remarkHistory {
      background: #f9fafb;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 6px;
      max-height: 250px;
      overflow-y: auto;
      font-size: 13px;
      margin-bottom: 12px;
    }

    #remarkHistory div {
      border-bottom: 1px solid #eee;
      padding: 6px 0;
    }

    #remarkText {
      flex-grow: 1;
      min-height: 100px;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
      resize: vertical;
    }

    #remarkModal .actions {
      margin-top: 12px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    #remarkModal .actions button {
      padding: 8px 14px;
      font-size: 14px;
    }

    /* Tooltip styling */
    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 280px;
      max-height: 250px;
      overflow-y: auto;
      background-color: #111827;
      color: #fff;
      text-align: left;
      border-radius: 8px;
      padding: 8px;
      position: absolute;
      z-index: 100;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.2s;
      font-size: 12px;
      white-space: normal;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    /* Pagination */
    .pagination {
      margin-top: 15px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }

    .pagination button {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
    }

    .pagination-info {
      font-size: 13px;
      color: #374151;
    }
  </style>
</head>

<body>
  <h1>Admin - Lead Management</h1>
  <div class="filters">
    <td></td>
    <td><input type="text" placeholder="Search Name" onkeyup="applyFilters()" id="filterName"></td>
    <td><input type="text" placeholder="Search Contact" onkeyup="applyFilters()" id="filterContact"></td>
    <td><input type="text" placeholder="Search Email" onkeyup="applyFilters()" id="filterEmail"></td>
    <td><input type="text" placeholder="Designation" onkeyup="applyFilters()" id="filterDesignation"></td>
    <td><input type="text" placeholder="Company" onkeyup="applyFilters()" id="filterCompany"></td>
    <td><input type="text" placeholder="City" onkeyup="applyFilters()" id="filterCity"></td>
    <td><input type="text" placeholder="Referred By" onkeyup="applyFilters()" id="filterReferred"></td>
    <td></td>
    <td></td>
  </div>
  <table id="leadsTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Name</th>
        <th>Contact</th>
        <th>Email</th>
        <th>Designation</th>
        <th>Company</th>
        <th>City</th>
        <th>Referred By</th>
        <th>Action</th>
      </tr>
      <!-- Filters -->

    </thead>
    <tbody></tbody>
  </table>

  <!-- Pagination Controls -->
  <div class="pagination">
    <button onclick="prevPage()">Previous</button>
    <span class="pagination-info" id="paginationInfo"></span>
    <button onclick="nextPage()">Next</button>
  </div>

  <!-- Modal -->
  <div id="remarkModal">
    <div class="modal-box">
      <h3>Remarks</h3>
      <div id="remarkHistory"></div>
      <textarea id="remarkText" placeholder="Add new remark..."></textarea>
      <div class="actions">
        <button onclick="closeModal()">Cancel</button>
        <button onclick="saveRemark()">Save</button>
      </div>
    </div>
  </div>

  <script>
    document.getElementById('remarkModal').style.display = 'none';
    let leads = [];
    let filteredLeads = [];
    let currentLeadId = null;

    let currentPage = 1;
    const rowsPerPage = 10;

    async function fetchLeads() {
      const res = await fetch('/api/leads');
      const data = await res.json();
      if (data.success) {
        leads = data.data;
        filteredLeads = leads;
        renderTable();
      }
    }

    function renderTable() {
      const tbody = document.querySelector('#leadsTable tbody');
      tbody.innerHTML = '';

      const totalPages = Math.ceil(filteredLeads.length / rowsPerPage);
      if (currentPage > totalPages) currentPage = totalPages || 1;

      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const rows = filteredLeads.slice(start, end);

      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;color:#6b7280;padding:20px;">No results</td></tr>`;
        document.getElementById('paginationInfo').innerText = "Page 0 of 0";
        return;
      }

      rows.forEach(lead => {
        let tooltipHtml = '';
        if (lead.remarks && lead.remarks.length) {
          tooltipHtml = lead.remarks.map(r =>
            `<div><strong>${new Date(r.date).toLocaleString()}</strong>: ${r.text}</div>`
          ).join('');
        } else {
          tooltipHtml = '<em>No remarks yet</em>';
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="nowrap">${formatDMY(lead.createdAt)}</td>
          <td>${lead.fullName || ''}</td>
          <td class="mono">${lead.mobileNumber || ''}</td>
          <td>${lead.emailAddress || ''}</td>
          <td>${lead.designation || ''}</td>
          <td>${lead.companyName || ''}</td>
          <td>${lead.city || ''}</td>
          <td>${lead.referredBy || ''}</td>
          <td>
            <div class="tooltip">
              <button onclick="openModal('${lead._id}')">Remarks</button>
              <div class="tooltiptext">${tooltipHtml}</div>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('paginationInfo').innerText = `Page ${currentPage} of ${totalPages}`;
    }

    function formatDMY(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleDateString('en-GB');
    }

    function openModal(leadId) {
      currentLeadId = leadId;
      const lead = leads.find(l => l._id === leadId);
      const historyBox = document.getElementById('remarkHistory');
      historyBox.innerHTML = '';
      if (lead.remarks && lead.remarks.length) {
        lead.remarks.forEach(r => {
          historyBox.innerHTML += `<div><strong>${new Date(r.date).toLocaleString()}:</strong> ${r.text}</div>`;
        });
      } else {
        historyBox.innerHTML = `<em>No previous remarks</em>`;
      }
      document.getElementById('remarkText').value = '';
      document.getElementById('remarkModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('remarkModal').style.display = 'none';
      currentLeadId = null;
    }

    async function saveRemark() {
      const text = document.getElementById('remarkText').value.trim();
      if (!text) { alert('Remark is required'); return; }

      const res = await fetch(`/api/leads/${currentLeadId}/remarks`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      });
      const data = await res.json();

      if (data.success) {
        closeModal();
        fetchLeads();
      } else {
        alert(data.message || 'Failed to save remark');
      }
    }

    function applyFilters() {
      const name = document.getElementById('filterName').value.toLowerCase();
      const contact = document.getElementById('filterContact').value.toLowerCase();
      const email = document.getElementById('filterEmail').value.toLowerCase();
      const designation = document.getElementById('filterDesignation').value.toLowerCase();
      const company = document.getElementById('filterCompany').value.toLowerCase();
      const city = document.getElementById('filterCity').value.toLowerCase();
      const referred = document.getElementById('filterReferred').value.toLowerCase();

      filteredLeads = leads.filter(l =>
        (!name || (l.fullName || '').toLowerCase().includes(name)) &&
        (!contact || (l.mobileNumber || '').toLowerCase().includes(contact)) &&
        (!email || (l.emailAddress || '').toLowerCase().includes(email)) &&
        (!designation || (l.designation || '').toLowerCase().includes(designation)) &&
        (!company || (l.companyName || '').toLowerCase().includes(company)) &&
        (!city || (l.city || '').toLowerCase().includes(city)) &&
        (!referred || (l.referredBy || '').toLowerCase().includes(referred))
      );

      currentPage = 1;
      renderTable();
    }

    function nextPage() {
      const totalPages = Math.ceil(filteredLeads.length / rowsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderTable();
      }
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderTable();
      }
    }

    fetchLeads();
  </script>
</body>

</html>